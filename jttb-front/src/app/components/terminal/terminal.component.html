<div class="terminal-container"
     (click)="onContainerClick($event)"
     (dragover)="onDragOver($event)"
     (dragleave)="onDragLeave($event)"
     (drop)="onDrop($event)">
  <div class="terminal-header">
    <div class="header-left">
      <img src="assets/logo-edr.png" alt="EdR" class="edr-mini">
      <span class="logo">JTTB</span>
      <span class="status">Connected</span>
    </div>
    <div class="header-right">
      <div class="donate-dropdown">
        <span class="donate-trigger" title="Support this project"><span class="heart-icon">â¤ï¸</span> <small class="support-text">Support</small></span>
        <div class="donate-menu">
          <span class="donate-title">Support JTTB</span>
          <a href="https://ko-fi.com/edering" target="_blank">â˜• Ko-fi</a>
          <a href="https://paypal.me/ederingar" target="_blank">ğŸ’³ PayPal</a>
          <span class="donate-divider"></span>
          <span class="donate-subtitle">Mercado Pago (ARS)</span>
          <a href="https://mpago.la/1BGY98f" target="_blank">$100</a>
          <a href="https://mpago.la/1J9LbmG" target="_blank">$300</a>
          <a href="https://mpago.la/2LDQsMa" target="_blank">$1000</a>
        </div>
      </div>
      <button class="logout-btn" (click)="authService.logout(); router.navigate(['/login'])">
        Logout
      </button>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="terminal-toolbar">
    <button class="toolbar-btn" (click)="toggleSearch()" [class.active]="showSearch" title="Search (Ctrl+F)">
      ğŸ” <span>Search</span>
    </button>
    <button class="toolbar-btn" (click)="toggleFavoritesPanel()" [class.active]="showFavorites" title="Favorites">
      â­ <span>Favorites</span>
      <span class="badge" *ngIf="favorites.length">{{ favorites.length }}</span>
    </button>
  </div>

  <!-- Search bar -->
  <div class="search-bar" *ngIf="showSearch">
    <input
      #searchInput
      type="text"
      [(ngModel)]="searchTerm"
      (input)="onSearch()"
      (keydown.escape)="toggleSearch()"
      placeholder="Search in output..."
      autofocus
    >
    <span class="search-count" *ngIf="searchTerm">{{ totalMatches }} matches</span>
    <button class="search-close" (click)="toggleSearch()" title="Close (Esc)">âœ•</button>
  </div>

  <!-- Drop zone overlay -->
  <div class="drop-overlay" *ngIf="isDragging">
    <div class="drop-content">
      <span class="drop-icon">ğŸ“</span>
      <span class="drop-text">Soltar archivo para subir a {{ shortCwd }}</span>
    </div>
  </div>

  <div class="terminal-body">
  <div class="terminal-output" #terminalOutput>
    <div class="welcome-message">
      <pre>
     â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
     â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â–ˆâ–ˆ   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
 â•šâ•â•â•â•â•    â•šâ•â•      â•šâ•â•   â•šâ•â•â•â•â•â•
      </pre>
      <p>JTTB - Terminal Toolbox v1.4</p>
      <p class="help-hint">Type 'help' for commands</p>
    </div>

    <span style="display:none">{{ resetMatchIndex() }}</span>
    <div *ngFor="let item of history" class="command-block">
      <div class="command-line">
        <span class="prompt">JTTB:[{{ item.cwd || '~' }}]$</span>
        <span class="command">{{ item.command }}</span>
        <button class="favorite-btn" (click)="onFavoriteClick($event, item.command)" [class.active]="isFavorite(item.command)" title="Add to favorites">
          {{ isFavorite(item.command) ? 'â˜…' : 'â˜†' }}
        </button>
      </div>
      <div class="output" *ngIf="item.stdout">
        <pre [innerHTML]="highlightText(item.stdout)"></pre>
      </div>
      <div class="error" *ngIf="item.stderr">
        <pre [innerHTML]="highlightText(item.stderr)"></pre>
      </div>
    </div>
  </div>

  <!-- Favorites sidebar -->
  <div class="favorites-panel" *ngIf="showFavorites">
    <div class="favorites-header">Favorites</div>
    <div class="favorites-add">
      <input
        type="text"
        [(ngModel)]="newFavorite"
        (keydown.enter)="addNewFavorite()"
        placeholder="Add command..."
      >
      <button (click)="addNewFavorite()" title="Add">+</button>
    </div>
    <div class="favorites-list" *ngIf="favorites.length > 0">
      <div *ngFor="let fav of favorites" class="favorite-item">
        <span class="favorite-command" (click)="useFavorite(fav)">{{ fav }}</span>
        <span class="favorite-remove" (click)="removeFavorite(fav)" title="Remove">âœ•</span>
      </div>
    </div>
    <div class="favorites-empty" *ngIf="favorites.length === 0">
      No favorites yet.<br>Click â˜† next to a command to add it.
    </div>
  </div>

  <!-- Search results sidebar -->
  <div class="search-results" *ngIf="showSearch && matchingLines.length > 0">
    <div class="search-results-header">Results</div>
    <div class="search-results-list">
      <div
        *ngFor="let match of matchingLines"
        class="search-result-item"
        [class.error]="match.type === 'stderr'"
        (click)="scrollToHistoryItem(match.index)">
        <span class="result-index">#{{ match.index + 1 }}</span>
        <span class="result-text">{{ match.text }}</span>
      </div>
    </div>
  </div>
  </div>

  <div class="terminal-input">
    <span class="prompt">JTTB:[{{ shortCwd }}]$</span>
    <input
      #commandInput
      type="text"
      [(ngModel)]="currentCommand"
      (keydown.enter)="executeCommand()"
      (keydown)="onKeyDown($event)"
      [disabled]="loading"
      autocomplete="off"
      spellcheck="false"
      autofocus
    >
    <span class="loading-indicator" *ngIf="loading">...</span>
  </div>
</div>
